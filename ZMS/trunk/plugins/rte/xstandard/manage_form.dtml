<dtml-comment>
################################################################################
### XStandard XHTML WYSIWYG Editor
###  please refer to http://xstandard.com
################################################################################
</dtml-comment>

<dtml-unless "REQUEST.get('f_zmiRichtextOnSubmitEventHandler')">
<script type="text/javascript">
<!--//

 var zmiRichtextElNames = new Array();
 <dtml-call "REQUEST.set('count',0)"
 ><dtml-in "getObjAttrs(REQUEST.get('ZMS_INSERT',meta_id)).keys()"
  ><dtml-let key=sequence-item obj_attr="getObjAttr(key,REQUEST.get('ZMS_INSERT',meta_id))"
   ><dtml-if "obj_attr.get('type',_.None)=='richtext'"
    >zmiRichtextElNames[<dtml-var count>]='<dtml-var "getObjAttrName(obj_attr,lang)">';<dtml-call "REQUEST.set('count',count+1)"
    ></dtml-if>
   </dtml-let
 ></dtml-in
 ><dtml-if "count==0"
  >zmiRichtextElNames[<dtml-var count>]='<dtml-var "REQUEST.get('elName')">';<dtml-call "REQUEST.set('count',count+1)"
 ></dtml-if>

  function zmiRichtextInit(elName, validateXML) {
    var txt = $('#'+elName).val();
    if ( txt.length > 0) {
      var zmiStandardEditorShow = false;
      var ltxt = "<root>"+txt.toLowerCase()+"</root>";
      if ( (ltxt.indexOf( "<form") >= 0) || 
           (ltxt.indexOf( "<input") >= 0) || 
           (ltxt.indexOf( "<script") >= 0) || 
           (ltxt.indexOf( "<"+"dtml-") >= 0)) {
        zmiStandardEditorShow = true;
      }
      else {
        try {
          if ( validateXML) {
            if (window.DOMParser) {
              confirm( "window.DOMParser");
              var parser=new DOMParser();
              var doc=parser.parseFromString(ltxt,"text/xml");
              if ( doc.childNodes[0].nodeName == 'parsererror') {
                throw '<dtml-var "getZMILangStr('CAPTION_WARNING')">\n'+doc.childNodes[0].childNodes[0].nodeValue+'\n';
              }
            } else if (window.ActiveXObject) {
              var xmlDoc=new ActiveXObject("Microsoft.XMLDOM");
              xmlDoc.async="false";
              xmlDoc.loadXML(ltxt);
              if ( xmlDoc.childNodes.length == 0) {
                throw '<dtml-var "getZMILangStr('CAPTION_WARNING')">\n'+'Invalid (X)HTML!\n';
              }
            }
          }
          $('#editor_'+elName).val( txt);
          $('#editor_'+elName+'_value').val( txt);
        }
        catch(e) {
          alert(e);
          zmiStandardEditorShow = true;
        }
      }
      if ( zmiStandardEditorShow) {
        zmiRichtextEditorShow('zmiStandardEditor'+elName,'zmiRichtextEditor'+elName<dtml-if "REQUEST.get('htmledit_fmt')">,'<dtml-var "REQUEST.get('htmledit_fmt').getId()">'</dtml-if>);
      }
    }
  }

  function zmiStandardOnSubmitEventHandler() {
    for (e in zmiRichtextElNames) {
      var elName = zmiRichtextElNames[e];
      var el = document.getElementById('zmiStandardEditor'+elName);
      if ( el.style.display != 'none' && el.style.visibility != 'hidden') {
        try {
          document.getElementById('editor_'+elName).value = document.getElementById(elName).value;
          document.getElementById('editor_'+elName+'_value').value = document.getElementById(elName).value;
        }
        catch(er) {
        }
      }
    }
  }

  <dtml-call "REQUEST.set('beforeSubmitBtnClick','zmiRichtextOnSubmitEventHandler(); ')">
  function zmiRichtextOnSubmitEventHandler() {
    for (e in zmiRichtextElNames) {
      var elName = zmiRichtextElNames[e];
      var el = document.getElementById('zmiRichtextEditor'+elName);
      if ( el.style.display != 'none' && el.style.visibility != 'hidden') {
        try {
          if(typeof(document.getElementById('editor_'+elName).EscapeUnicode) == 'undefined') {
            throw "Error"
          } else {
            document.getElementById('editor_'+elName).EscapeUnicode = true;
            var v = document.getElementById('editor_'+elName).value;
            if ( v.indexOf( '<!-- Generated by XStandard ') == 0) {
              v = v.substring( v.indexOf( '-->')+3);
            }
            document.getElementById(elName).value = v;
          }
        }
        catch(er) {
          document.getElementById(elName).value = document.getElementById('alternate_'+elName).value;
        }
      }
    }
  }

//-->
</script>
<dtml-call "REQUEST.set('f_zmiRichtextOnSubmitEventHandler',_.True)">
</dtml-unless>

<object id="editor_<dtml-var "REQUEST.get('elName')">"
        name="editor_<dtml-var "REQUEST.get('elName')">"
   <dtml-if "REQUEST.get('HTTP_USER_AGENT','').find('MSIE 7')>0">classid="clsid:0EED7206-1661-11D7-84A3-00606744831D"<dtml-else>type="application/x-xstandard"</dtml-if>
   width="100%" height="400"
   codebase="<dtml-var "REQUEST.get('codebase_protocol',absolute_url()[:absolute_url().find(':')])">://bscw.hoffmannliebenberg.de/pub/bscw.cgi/d293146/XStandard.cab#Version=2,0,0,0">
  <param name="CMSCode" value="9CF6B9BD-B73D-4206-8A77-8E05477E9726" />
  <param name="ToolbarWysiwyg" value="ordered-list, unordered-list, , draw-layout-table, draw-data-table, image, separator, hyperlink, attachment,  undo, wysiwyg, source, help" />
  <param name="EnablePasteMarkup" value="yes" />
  <param name="Styles" value="<dtml-var "getDocumentElement().absolute_url().replace('https://','http://')">/f_xstandard_styles" />
  <param name="CSS" value="<dtml-var "getStylesheet().absolute_url().replace('https://','http://')">" />
  <param name="Lang" value="<dtml-if "lang=='ger'">de<dtml-else>en</dtml-if>" />
  <param name="CMSImageLibraryURL" value="<dtml-var "getDocumentElement().absolute_url().replace('https://','http://')">/f_xstandard_browseImages" />
  <param name="CMSAttachmentLibraryURL" value="<dtml-var "getDocumentElement().absolute_url().replace('https://','http://')">/f_xstandard_browseFiles" />
  <param name="Options" value="1" />
  <param id="editor_<dtml-var "REQUEST.get('elName')">_value" name="Value" value="" />
  <dtml-if "REQUEST.get('URL','').find('https://')==0">
   <div class="form-small">[<a href="?codebase_protocol=http" class="zmi">Install XStandard via HTTP</a>]</div>
  </dtml-if>
  <textarea name="alternate_<dtml-var "REQUEST.get('elName')">" id="alternate_<dtml-var "REQUEST.get('elName')">" cols="50" rows="15" style="width:100%"><dtml-var "REQUEST.get('data')" html_quote ></textarea>
</object>

<script type="text/javascript">
<!--//

  zmiRichtextInit('<dtml-var "REQUEST.get('elName')">');

//-->
</script>
